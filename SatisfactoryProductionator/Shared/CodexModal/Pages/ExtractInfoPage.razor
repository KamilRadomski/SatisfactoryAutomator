@using SatisfactoryProductionator.DataModels.Enums;
@using SatisfactoryProductionator.DataModels.Models.Codex;
@using SatisfactoryProductionator.DataModels.Models;
@using SatisfactoryProductionator.Services;

@inject CodexModalState CodexModalState;
@inject CodexState CodexState;

@implements IDisposable

<table class="info-panel-recipe-table">
    <tr>
        <td colspan="4" class="info-panel-recipe-header">@FormatCategoryName(GetPageType().ToString())</td>
    </tr>
    @foreach (var recipe in GetRecipes())
    {
        var buildingInfo = GetBuildingInfo(@recipe.Building);
        <tr>
            <td>
                <button class="info-panel-recipe-button" type="button" @onclick="@(() => SetSelectedItem(buildingInfo.ClassName))">
                    <img class="building-image" src=@buildingInfo.IconPath alt=@buildingInfo.DisplayName />
                    <div class="info-panel-recipe-quantity">@buildingInfo.DisplayName</div>
                </button>
            </td>
            <td> >>> </td>
            <td>
                <table>
                    <tr>
                        @foreach (var item in recipe.Outputs.Values)
                        {
                            var i = 0;
                            foreach (var value in item)
                            {
                                <td>
                                    <div class="extract-space">
                                        <img class="extract-image @GetBackgroundColorCss(i++, item.Length)" src=@selectedEntry.CodexItem.IconPath alt=@selectedEntry.CodexItem.DisplayName />
                                        <div class="info-panel-recipe-quantity">X @value.ToString()/min </div>
                                    </div>
                                </td>
                            }
                        }
                    </tr>
                </table>
            </td>
        </tr>
    }
</table>

@code {
    [CascadingParameter(Name = "SelectedEntry")]
    public ModalEntry selectedEntry { get; set; }

    protected override void OnInitialized()
    {
        base.OnInitialized();

        CodexModalState.OnStateChange += StateHasChanged;
        CodexState.OnStateChange += StateHasChanged;
    }

    public void Dispose()
    {
        CodexModalState.OnStateChange -= StateHasChanged;
        CodexState.OnStateChange -= StateHasChanged;
    }

    private List<Recipe> GetRecipes()
    {
        var index = selectedEntry.Index;
        var recipeNames = selectedEntry.CodexItem.Pages[index].Recipes;

        var recipes = CodexState.FetchRecipes(recipeNames);

        return recipes;
    }

    private string FormatCategoryName(string name)
    {
        for (int i = name.Length - 1; i > 0; i--)
        {
            if (char.IsUpper(name[i]))
            {
                name = name.Insert(i, ".");
            }
        }
        return name;
    }

    private PageType GetPageType()
    {
        var index = selectedEntry.Index;

        return selectedEntry.CodexItem.Pages[index].PageType;
    }

    private CodexItem GetBuildingInfo(string className)
    {
        return CodexState.FetchItem(className);
    }

    private void SetSelectedItem(string itemName)
    {
        var item = CodexState.FetchItem(itemName);
        CodexModalState.SetSelectedItem(item);
    }

    private string GetBackgroundColorCss(int i, int count)
    {
        if (count < 2) return string.Empty;

        return i switch
        {
            0 => "impure",
            1 => "normal",
            2 => "pure"
        };
    }
}
